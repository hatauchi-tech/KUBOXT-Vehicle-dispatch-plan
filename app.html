<script>
/**
 * =============================================================================
 * app.js - クライアントサイドメインロジック (v3.1 - 編集・削除機能追加)
 * =============================================================================
 */

(function() {
  'use strict';
  
  // ===========================================================================
  // ★ サーバーサイドからの変数取得 ★
  // ===========================================================================
  
  if (!window.APP_CONFIG) {
    console.error('[ERROR] APP_CONFIG が定義されていません。呼び出し元のHTMLファイルを確認してください。');
    throw new Error('APP_CONFIG が定義されていません');
  }
  const CURRENT_PAGE = window.APP_CONFIG.currentPage;
  const BASE_URL = window.APP_CONFIG.baseUrl;

  console.log('[DEBUG] APP_CONFIG loaded:', window.APP_CONFIG);
  console.log('[DEBUG] CURRENT_PAGE:', CURRENT_PAGE);
  console.log('[DEBUG] BASE_URL:', BASE_URL);
  
  // ===========================================================================
  // グローバルステート
  // ===========================================================================
  
  const AppState = {
    currentPage: CURRENT_PAGE,
    shippers: [],
    vehicles: [],
    requestTypes: [],
    requests: [],
    selectedRequest: null,
    loading: false,
    
    // ★ NEW: フォームの編集モード管理
    currentFormMode: 'create', // 'create' または 'edit'
    currentEditingRequestId: null, // 編集中の依頼ID
  };
  
  // ===========================================================================
  // API通信モジュール
  // ===========================================================================
  
  const API = {
    /**
     * GAS関数を呼び出す共通メソッド
     */
    call(functionName, ...args) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(result => {
            if (result && result.success === false) {
              reject(new Error(result.message || 'エラーが発生しました'));
            } else {
              resolve(result);
            }
          })
          .withFailureHandler(error => {
            console.error(`API Error [${functionName}]:`, error);
            reject(new Error('サーバーとの通信に失敗しました'));
          })
          [functionName](...args);
      });
    },
    
    /**
     * すべての荷主データを取得
     */
    async getAllShippers() {
      const result = await this.call('apiGetAllShippers');
      return result.data || [];
    },
    
    /**
     * すべての車両データを取得
     */
    async getAllVehicles() {
      const result = await this.call('apiGetAllVehicles');
      return result.data || [];
    },
    
    /**
     * ユニークな依頼車種リストを取得
     */
    async getUniqueRequestTypes() {
      const result = await this.call('apiGetUniqueRequestTypes');
      return result.data || [];
    },

    /**
     * ★ NEW: 依頼IDで単一の依頼データを取得
     */
    async getRequestById(requestId) {
      const result = await this.call('apiGetRequestById', requestId);
      return result.data || null;
    },
    
    /**
     * すべての依頼データを取得
     */
    async getAllRequests() {
      const result = await this.call('apiGetAllRequests');
      return result.data || [];
    },
    
    /**
     * 未配車の依頼データを取得
     */
    async getUnassignedRequests() {
      const result = await this.call('apiGetUnassignedRequests');
      return result.data || [];
    },
    
    /**
     * 日付範囲で依頼データを取得
     */
    async getRequestsByDateRange(startDate, endDate) {
      const result = await this.call('apiGetRequestsByDateRange', startDate, endDate);
      return result.data || [];
    },
    
    /**
     * 新しい依頼を登録
     */
    async createRequest(requestData) {
      const requestJson = JSON.stringify(requestData);
      return await this.call('apiCreateRequest', requestJson);
    },

    /**
     * ★ NEW: 依頼を更新
     */
    async updateRequest(requestData) {
      const requestJson = JSON.stringify(requestData);
      return await this.call('apiUpdateRequest', requestJson);
    },

    /**
     * ★ NEW: 依頼を削除
     */
    async deleteRequest(requestId) {
      return await this.call('apiDeleteRequest', requestId);
    },
    
    /**
     * 依頼に車両を割り当て
     */
    async assignVehicle(requestId, vehicleNumber) {
      return await this.call('apiAssignVehicle', requestId, vehicleNumber);
    },
    
    /**
     * 依頼の車両割り当てを解除
     */
    async unassignVehicle(requestId) {
      return await this.call('apiUnassignVehicle', requestId);
    },
    
    /**
     * 指定された依頼に割り当て可能な車両を取得
     */
    async getAvailableVehicles(requestData) {
      const requestJson = JSON.stringify(requestData);
      const result = await this.call('apiGetAvailableVehicles', requestJson);
      return result.data || [];
    },
    
    /**
     * アプリケーション情報を取得
     */
    async getAppInfo() {
      const result = await this.call('apiGetAppInfo');
      return result.data || {};
    }
  };
  
  // ===========================================================================
  // UI制御モジュール
  // ===========================================================================
  
  const UI = {
    showLoading(message = '読み込み中...') {
      AppState.loading = true;
      const loadingHtml = `
        <div class="loading-overlay" id="loadingOverlay">
          <div class="loading-spinner">
            <div class="preloader-wrapper active">
              <div class="spinner-layer spinner-blue-only">
                <div class="circle-clipper left">
                  <div class="circle"></div>
                </div>
                <div class="gap-patch">
                  <div class="circle"></div>
                </div>
                <div class="circle-clipper right">
                  <div class="circle"></div>
                </div>
              </div>
            </div>
            <p>${message}</p>
          </div>
        </div>
      `;
      this.hideLoading();
      document.body.insertAdjacentHTML('beforeend', loadingHtml);
    },
    
    hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.remove();
      }
      document.querySelectorAll('.loading-overlay').forEach(el => {
        el.remove();
      });
      AppState.loading = false;
    },
    
    showToast(message, type = 'info', duration = 3000) {
      const className = type === 'success' ? 'success' : 
                        type === 'error' ? 'error' : '';
      M.toast({ html: message, classes: className, displayLength: duration });
    },
    
    showError(message) {
      this.showToast(message, 'error', 5000);
    },
    
    showSuccess(message) {
      this.showToast(message, 'success', 3000);
    },
    
    /**
     * ★ MOD: 確認ダイアログ
     * (window.confirmはUIがブロックされるため、Materializeのモーダル利用を推奨しますが、
     * ここでは簡潔さのため window.confirm を継続利用します)
     */
    confirm(message) {
      // 本番環境ではカスタムモーダル（M.Modal）に置き換えることを推奨
      return window.confirm(message);
    }
  };
  
  // ===========================================================================
  // バリデーションモジュール
  // ===========================================================================
  
  const Validator = {
    required(value, fieldName) {
      if (!value || String(value).trim() === '') {
        return `${fieldName}は必須項目です`;
      }
      return null;
    },
    
    isValidDate(value, fieldName) {
      if (!value) {
        return `${fieldName}を入力してください`;
      }
      const date = new Date(value);
      if (isNaN(date.getTime())) {
        return `${fieldName}の形式が正しくありません`;
      }
      return null;
    },
    
    dateRange(startDate, endDate, startFieldName, endFieldName) {
      const start = new Date(startDate);
      const end = new Date(endDate);
      if (start > end) {
        return `${endFieldName}は${startFieldName}以降の日付を指定してください`;
      }
      return null;
    },
    
    validateForm(formData, rules) {
      const errors = [];
      for (const [field, rule] of Object.entries(rules)) {
        const value = formData[field];
        if (rule.required) {
          const error = this.required(value, rule.label);
          if (error) errors.push(error);
        }
        if (rule.type === 'date' && value) {
          const error = this.isValidDate(value, rule.label);
          if (error) errors.push(error);
        }
      }
      return errors;
    }
  };
  
  // ===========================================================================
  // ユーティリティモジュール
  // ===========================================================================
  
  const Utils = {
    formatDate(date) {
      if (!date) return '';
      const d = new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    },
    
    /**
     * ★ NEW: 時刻を HH:mm 形式でフォーマット
     */
    formatTime(time) {
      if (!time) return '';
      const d = new Date(time);
      const hours = String(d.getHours()).padStart(2, '0');
      const minutes = String(d.getMinutes()).padStart(2, '0');
      return `${hours}:${minutes}`;
    },
    
    formatDateJP(date) {
      if (!date) return '';
      const d = new Date(date);
      const year = d.getFullYear();
      const month = d.getMonth() + 1;
      const day = d.getDate();
      return `${year}年${month}月${day}日`;
    },
    
    getToday() {
      return this.formatDate(new Date());
    },
    
    filterArray(array, filterFn) {
      if (!Array.isArray(array)) return [];
      return array.filter(filterFn);
    },
    
    sortArray(array, key, ascending = true) {
      if (!Array.isArray(array)) return [];
      return [...array].sort((a, b) => {
        const aVal = a[key];
        const bVal = b[key];
        if (aVal < bVal) return ascending ? -1 : 1;
        if (aVal > bVal) return ascending ? 1 : -1;
        return 0;
      });
    },
    
    cloneObject(obj) {
      return JSON.parse(JSON.stringify(obj));
    },
    
    toggleElement(elementId, show) {
      const element = document.getElementById(elementId);
      if (element) {
        element.style.display = show ? 'block' : 'none';
      }
    },
    
    populateSelect(selectId, options, valueKey, textKey, placeholder = '選択してください') {
      const select = document.getElementById(selectId);
      if (!select) return;
      select.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
      options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option[valueKey];
        optionElement.textContent = option[textKey];
        select.appendChild(optionElement);
      });
      M.FormSelect.init(select);
    },
    
    clearForm(formId) {
      const form = document.getElementById(formId);
      if (form) {
        form.reset();
        
        // 隠しフィールドもクリア
        const hiddenId = document.getElementById('requestId');
        if (hiddenId) hiddenId.value = '';

        const selects = form.querySelectorAll('select');
        selects.forEach(select => {
          M.FormSelect.init(select);
        });
        
        // Materializeのテキストフィールドのラベルをリセット
        const labels = form.querySelectorAll('label');
        labels.forEach(label => {
          label.classList.remove('active');
        });
        // Date/Timeピッカーのラベルはactiveを維持
        const datePickers = form.querySelectorAll('.datepicker, .timepicker');
        datePickers.forEach(picker => {
          const label = picker.nextElementSibling;
          if(label) label.classList.add('active');
        });
      }
    }
  };
  
  // ===========================================================================
  // ナビゲーションモジュール
  // ===========================================================================
  
  const Navigation = {
    _navigating: false,
    _currentState: {}, // ★ NEW: ページ遷移時の状態を保持

    /**
     * ★ MOD: ページ遷移に state を追加
     */
    navigateToPage(pageName, state = {}, meta = { source: 'unknown' }) {
      console.log('[SPA] navigateToPage called with:', pageName, 'state:', state, 'source:', meta.source);

      if (this._navigating) {
        console.log('[WARN] Navigation already in progress, ignoring');
        return;
      }

      // 同一ページでも state が異なる場合は遷移を許可
      if (pageName === AppState.currentPage && JSON.stringify(state) === JSON.stringify(this._currentState)) {
        console.log('[SPA] Already on page with same state:', pageName);
        return;
      }

      this._navigating = true;
      UI.showLoading('ページを読み込んでいます...');
      
      this._currentState = state; // ★ NEW: stateを保存

      google.script.run
        .withSuccessHandler((html) => {
          console.log('[SPA] Page content loaded successfully for:', pageName);

          const contentDiv = document.getElementById('page-content');
          if (contentDiv) {
            contentDiv.innerHTML = html;
          } else {
            console.error('[ERROR] page-content div not found!');
            UI.showError('ページコンテンツの配置に失敗しました');
            UI.hideLoading();
            this._navigating = false;
            return;
          }

          AppState.currentPage = pageName;
          this.updateActiveNavLinks(pageName);

          // ★ MOD: ページ固有の初期化に state を渡す
          App.initPage(this._currentState).then(() => {
            UI.hideLoading();
            this._navigating = false;
            console.log('[SPA] Navigation completed successfully to:', pageName);
          }).catch((error) => {
            console.error('[ERROR] Page initialization failed:', error);
            UI.hideLoading();
            UI.showError('ページの初期化に失敗しました: ' + error.message);
            this._navigating = false;
          });
        })
        .withFailureHandler((error) => {
          console.error('[ERROR] Failed to load page content:', error);
          UI.hideLoading();
          UI.showError('ページの読み込みに失敗しました: ' + error.message);
          this._navigating = false;
        })
        .getPageContent(pageName);
    },

    updateActiveNavLinks(activePage) {
      console.log('[SPA] Updating active nav links for:', activePage);

      document.querySelectorAll('nav li').forEach(li => {
        li.classList.remove('active');
      });

      document.querySelectorAll(`nav a[data-page="${activePage}"]`).forEach(link => {
        const li = link.closest('li');
        if (li) {
          li.classList.add('active');
        }
      });
    },

    setupEventListeners() {
      console.log('[SPA] Setting up navigation event listeners');

      const onClickNav = (e) => {
        console.log('[DEBUG] Click event:', {
          isTrusted: e.isTrusted,
          target: e.target.tagName,
          id: e.target.id
        });

        if (!e.isTrusted) {
          console.log('[WARN] Ignoring non-user click (isTrusted=false)');
          return;
        }

        e.preventDefault();

        const link = e.currentTarget;
        const pageName = link.getAttribute('data-page') || 'dispatch-plan';

        console.log('[SPA] User clicked nav link for page:', pageName);
        this.navigateToPage(pageName, {}, { source: 'user-click' }); // ★ MOD: 空の state を渡す
      };

      const brandLogo = document.getElementById('brandLogo');
      if (brandLogo) {
        console.log('[DEBUG] Setting up brandLogo click listener');
        brandLogo.addEventListener('click', onClickNav, { capture: true });
      }

      const navLinks = document.querySelectorAll('a[data-page]');
      console.log('[DEBUG] Found', navLinks.length, 'navigation links');
      navLinks.forEach((link, index) => {
        const pageName = link.getAttribute('data-page');
        console.log('[DEBUG] Setting up nav link', index, 'for page:', pageName);
        link.addEventListener('click', onClickNav, { capture: true });
      });

      console.log('[SPA] Navigation event listeners setup completed');
    }
  };
  
  // ===========================================================================
  // メインアプリケーションモジュール
  // ===========================================================================
  
  const App = {
    async init() {
      console.log('App initializing...');

      try {
        UI.showLoading('アプリケーションを初期化中...');
        this.setupEventListeners();
        this.initMaterialize();
        await this.loadMasterData();
        
        // ★ MOD: 起動時のページ初期化にも state を渡す
        await this.initPage(Navigation._currentState);

        UI.hideLoading();
        console.log('App initialized successfully');

      } catch (error) {
        console.error('App initialization error:', error);
        UI.hideLoading();
        UI.showError('アプリケーションの初期化に失敗しました: ' + error.message);
      }
    },
    
    initMaterialize() {
      console.log('[DEBUG] Initializing Materialize components manually');

      const sidenavElems = document.querySelectorAll('.sidenav');
      if (sidenavElems.length > 0) M.Sidenav.init(sidenavElems);

      const selectElems = document.querySelectorAll('select');
      if (selectElems.length > 0) M.FormSelect.init(selectElems);

      const datepickerElems = document.querySelectorAll('.datepicker');
      if (datepickerElems.length > 0) {
        M.Datepicker.init(datepickerElems, {
          format: 'yyyy-mm-dd', autoClose: true,
          i18n: {
            cancel: 'キャンセル', done: '選択',
            months: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
            monthsShort: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
            weekdays: ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'],
            weekdaysShort: ['日', '月', '火', '水', '木', '金', '土'],
            weekdaysAbbrev: ['日', '月', '火', '水', '木', '金', '土']
          }
        });
      }

      const timepickerElems = document.querySelectorAll('.timepicker');
      if (timepickerElems.length > 0) {
        M.Timepicker.init(timepickerElems, {
          twelveHour: false,
          i18n: { cancel: 'キャンセル', done: '選択' }
        });
      }

      const modalElems = document.querySelectorAll('.modal');
      if (modalElems.length > 0) M.Modal.init(modalElems);

      const tabsElems = document.querySelectorAll('.tabs');
      if (tabsElems.length > 0) M.Tabs.init(tabsElems);
      
      // ★ NEW: Materializeのテキストフィールドを更新（編集フォーム用）
      M.updateTextFields();
    },
    
    async loadMasterData() {
      console.log('Loading master data...');
      try {
        const [shippers, vehicles, requestTypes] = await Promise.all([
          API.getAllShippers(),
          API.getAllVehicles(),
          API.getUniqueRequestTypes()
        ]);
        AppState.shippers = shippers;
        AppState.vehicles = vehicles;
        AppState.requestTypes = requestTypes;
        console.log('Master data loaded');
      } catch (error) {
        console.error('Failed to load master data:', error);
        throw new Error('マスタデータの読み込みに失敗しました');
      }
    },
    
    /**
     * ★ MOD: ページの初期化に state を渡す
     */
    async initPage(state = {}) {
      const page = AppState.currentPage;
      console.log('Initializing page:', page, 'with state:', state);
      
      switch (page) {
        case 'request-form':
          await RequestForm.init(state); // ★ MOD
          break;
        case 'request-list':
          await RequestList.init();
          break;
        case 'dispatch-plan':
          await DispatchPlan.init();
          break;
        default:
          console.warn('Unknown page or no page-specific init required:', page);
      }
    },
    
    setupEventListeners() {
      Navigation.setupEventListeners();
    }
  };
  
  // ===========================================================================
  // ページ別モジュール
  // ===========================================================================
  
  // 依頼入力画面モジュール
  const RequestForm = {
    /**
     * ★ MOD: initがstateを受け取るように変更
     */
    async init(state = {}) {
      console.log('RequestForm init with state:', state);
      
      // フォームの状態を設定
      if (state.mode === 'edit' && state.requestId) {
        AppState.currentFormMode = 'edit';
        AppState.currentEditingRequestId = state.requestId;
      } else {
        AppState.currentFormMode = 'create';
        AppState.currentEditingRequestId = null;
      }
      
      this.setupEventListeners();
      this.setupFormUI(); // ★ UIを先に設定
      await this.populateFormData(); // ★ データを後に読み込む
    },

    /**
     * ★ NEW: フォームのUI（タイトル、ボタン）をモードに応じて設定
     */
    setupFormUI() {
      const title = document.getElementById('pageTitle');
      const subtitle = document.getElementById('pageSubtitle');
      const submitBtnText = document.getElementById('submitBtnText');
      const cancelBtnText = document.getElementById('cancelBtnText');

      if (AppState.currentFormMode === 'edit') {
        if (title) title.innerHTML = '<i class="material-icons large" style="vertical-align: middle;">edit</i> 依頼編集';
        if (subtitle) subtitle.textContent = `依頼ID: ${AppState.currentEditingRequestId} の内容を編集します`;
        if (submitBtnText) submitBtnText.textContent = '更新';
        if (cancelBtnText) cancelBtnText.textContent = 'キャンセル';
      } else {
        if (title) title.innerHTML = '<i class="material-icons large" style="vertical-align: middle;">add_circle</i> 依頼登録';
        if (subtitle) subtitle.textContent = '新規配送依頼を登録します';
        if (submitBtnText) submitBtnText.textContent = '登録';
        if (cancelBtnText) cancelBtnText.textContent = 'クリア';
      }
    },
    
    /**
     * ★ MOD: フォームのデータ入力（編集モード対応）
     */
    async populateFormData() {
      // 共通のマスタデータを設定
      Utils.populateSelect('shipper', AppState.shippers, 'shipperId', 'shipperName');
      Utils.populateSelect('requestType', AppState.requestTypes.map(type => ({
        value: type,
        label: type
      })), 'value', 'label');
      
      if (AppState.currentFormMode === 'edit') {
        // 編集モード：既存データを読み込む
        try {
          UI.showLoading('依頼データを読み込み中...');
          const data = await API.getRequestById(AppState.currentEditingRequestId);
          if (data) {
            document.getElementById('requestId').value = data.requestId;
            document.getElementById('receivedDate').value = Utils.formatDate(data.receivedDate);
            document.getElementById('shipper').value = data.shipper; // ★ 注意: shipperIdではなくshipperName
            document.getElementById('productName').value = data.productName;
            document.getElementById('requestType').value = data.requestType;
            document.getElementById('loadDate').value = Utils.formatDate(data.loadDate);
            document.getElementById('loadTime').value = data.loadTime; // HH:mm
            document.getElementById('loadPlace1').value = data.loadPlace1;
            document.getElementById('loadPlace2').value = data.loadPlace2;
            document.getElementById('unloadDate').value = Utils.formatDate(data.unloadDate);
            document.getElementById('unloadTime').value = data.unloadTime; // HH:mm
            document.getElementById('unloadPlace1').value = data.unloadPlace1;
            document.getElementById('unloadPlace2').value = data.unloadPlace2;
            
            // Materializeのselectを更新
            const selects = document.querySelectorAll('select');
            M.FormSelect.init(selects);
            
            // Materializeのラベルをアクティブ化
            M.updateTextFields();

          } else {
            UI.showError('依頼データの読み込みに失敗しました');
          }
          UI.hideLoading();
        } catch (error) {
          console.error('Load request data error:', error);
          UI.hideLoading();
          UI.showError('依頼データの読み込みに失敗しました: ' + error.message);
        }
      } else {
        // 新規登録モード：受付日を今日に設定
        const receivedDateInput = document.getElementById('receivedDate');
        if (receivedDateInput) {
          receivedDateInput.value = Utils.getToday();
        }
        // Materializeのラベルをアクティブ化
        M.updateTextFields();
      }
    },
    
    setupEventListeners() {
      const form = document.getElementById('requestForm');
      if (form) {
        // 既存のリスナーを削除（念のため）
        form.removeEventListener('submit', this.handleSubmit);
        form.addEventListener('submit', (e) => this.handleSubmit(e));
      }
      
      const cancelBtn = document.getElementById('cancelBtn');
      if (cancelBtn) {
        // 既存のリスナーを削除（念のため）
        cancelBtn.removeEventListener('click', this.handleCancel);
        cancelBtn.addEventListener('click', () => this.handleCancel());
      }
    },
    
    /**
     * ★ MOD: 送信処理（新規・編集を分岐）
     */
    async handleSubmit(e) {
      e.preventDefault();
      
      const formData = this.getFormData();
      const errors = this.validateFormData(formData);
      
      if (errors.length > 0) {
        UI.showError(errors.join('\n'));
        return;
      }
      
      try {
        if (AppState.currentFormMode === 'edit') {
          // 更新処理
          UI.showLoading('依頼を更新中...');
          const result = await API.updateRequest(formData);
          UI.hideLoading();
          
          if (result.success) {
            UI.showSuccess('依頼を更新しました (ID: ' + formData.requestId + ')');
            Navigation.navigateToPage('request-list', {}, { source: 'form-submit' });
          } else {
            UI.showError('依頼の更新に失敗しました: ' + result.message);
          }
          
        } else {
          // 新規登録処理
          UI.showLoading('依頼を登録中...');
          const result = await API.createRequest(formData);
          UI.hideLoading();
          
          if (result.success) {
            UI.showSuccess('依頼を登録しました (ID: ' + result.requestId + ')');
            Utils.clearForm('requestForm');
            this.setupFormUI(); // UIをリセット
            this.populateFormData(); // 受付日を再設定
          } else {
            UI.showError('依頼の登録に失敗しました: ' + result.message);
          }
        }
      } catch (error) {
        console.error('Submit error:', error);
        UI.hideLoading();
        UI.showError('処理に失敗しました: ' + error.message);
      }
    },
    
    /**
     * ★ MOD: getFormDataがrequestIdを含むように
     */
    getFormData() {
      return {
        requestId: document.getElementById('requestId').value, // ★ NEW
        receivedDate: document.getElementById('receivedDate').value,
        shipper: document.getElementById('shipper').value,
        loadDate: document.getElementById('loadDate').value,
        loadTime: document.getElementById('loadTime').value,
        loadPlace1: document.getElementById('loadPlace1').value,
        loadPlace2: document.getElementById('loadPlace2').value,
        productName: document.getElementById('productName').value,
        unloadDate: document.getElementById('unloadDate').value,
        unloadTime: document.getElementById('unloadTime').value,
        unloadPlace1: document.getElementById('unloadPlace1').value,
        unloadPlace2: document.getElementById('unloadPlace2').value,
        requestType: document.getElementById('requestType').value
      };
    },
    
    validateFormData(formData) {
      const errors = [];
      if (!formData.shipper) errors.push('荷主を選択してください');
      if (!formData.loadDate) errors.push('積込日を入力してください');
      if (!formData.loadPlace1) errors.push('積込地1を入力してください');
      if (!formData.productName) errors.push('品名を入力してください');
      if (!formData.unloadDate) errors.push('荷卸日を入力してください');
      if (!formData.unloadPlace1) errors.push('荷卸地1を入力してください');
      if (!formData.requestType) errors.push('依頼車種を選択してください');
      
      if (formData.loadDate && formData.unloadDate) {
        const error = Validator.dateRange(
          formData.loadDate,
          formData.unloadDate,
          '積込日',
          '荷卸日'
        );
        if (error) errors.push(error);
      }
      return errors;
    },
    
    /**
     * ★ MOD: キャンセル・クリア処理
     */
    handleCancel() {
      if (AppState.currentFormMode === 'edit') {
        // 編集モード時は一覧に戻る
        if (UI.confirm('編集をキャンセルして一覧に戻りますか?')) {
          Navigation.navigateToPage('request-list', {}, { source: 'form-cancel' });
        }
      } else {
        // 新規登録モード時はフォームをクリア
        if (UI.confirm('入力内容をクリアしますか?')) {
          Utils.clearForm('requestForm');
          this.populateFormData(); // 受付日を再設定
        }
      }
    }
  };
  
  // 依頼一覧モジュール
  const RequestList = {
    async init() {
      console.log('RequestList init');
      this.setupEventListeners();
      this.populateFilters();
      await this.loadRequests();
    },

    populateFilters() {
      Utils.populateSelect('filterShipper', AppState.shippers, 'shipperId', 'shipperName', 'すべての荷主');
    },
    
    async loadRequests() {
      try {
        UI.showLoading('依頼データを読み込み中...');
        const requests = await API.getAllRequests();
        AppState.requests = requests;
        this.renderTable(requests);
        this.updateRequestCount(requests.length);
        UI.hideLoading();
      } catch (error) {
        console.error('Load requests error:', error);
        UI.hideLoading();
        UI.showError('依頼データの読み込みに失敗しました');
      }
    },
    
    /**
     * ★ MOD: テーブル描画（編集・削除ボタン追加）
     */
    renderTable(requests) {
      const tbody = document.getElementById('requestTableBody');
      if (!tbody) return;
      
      if (requests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">データがありません</td></tr>';
        return;
      }
      
      // ★ MOD: 依頼日（loadDate）でソート（新しいものが上）
      const sortedRequests = Utils.sortArray(requests, 'loadDate', false);
      
      tbody.innerHTML = sortedRequests.map(req => `
        <tr>
          <!-- ★ NEW: 操作ボタン -->
          <td class="table-actions" style="min-width: 120px;">
            <button class="btn-small waves-effect waves-light blue edit-btn" data-request-id="${req.requestId}" title="編集">
              <i class="material-icons">edit</i>
            </button>
            <button class="btn-small waves-effect waves-light red delete-btn" data-request-id="${req.requestId}" title="削除">
              <i class="material-icons">delete</i>
            </button>
          </td>
          
          <!-- ステータス -->
          <td>
            ${req.vehicleNumber 
              ? '<span class="chip chip-assigned">配車済</span>' 
              : '<span class="chip chip-unassigned">未配車</span>'}
          </td>
          <td>${req.requestId}</td>
          <td>${Utils.formatDateJP(req.loadDate)}</td>
          <td>${req.shipper}</td>
          <td>${req.loadPlace1}</td>
          <td>${req.productName}</td>
          <td>${req.requestType}</td>
          <td>${req.vehicleNumber || '-'}</td>
          <td>${req.driverName || '-'}</td>
        </tr>
      `).join('');
    },
    
    /**
     * ★ MOD: イベントリスナー（編集・削除ボタン対応）
     */
    setupEventListeners() {
      const applyBtn = document.getElementById('applyFilterBtn');
      if (applyBtn) {
        applyBtn.addEventListener('click', () => this.applyFilters());
      }
      
      const resetBtn = document.getElementById('resetFilterBtn');
      if (resetBtn) {
        resetBtn.addEventListener('click', () => this.resetFilters());
      }
      
      // ★ NEW: テーブルのイベント委譲
      const tableBody = document.getElementById('requestTableBody');
      if (tableBody) {
        tableBody.addEventListener('click', (e) => {
          const editBtn = e.target.closest('.edit-btn');
          const deleteBtn = e.target.closest('.delete-btn');
          
          if (editBtn) {
            const requestId = editBtn.dataset.requestId;
            this.handleEditClick(requestId);
          } else if (deleteBtn) {
            const requestId = deleteBtn.dataset.requestId;
            this.handleDeleteClick(requestId);
          }
        });
      }
    },

    applyFilters() {
      if (!AppState.requests) return;
      
      const startDate = document.getElementById('filterStartDate').value;
      const endDate = document.getElementById('filterEndDate').value;
      const shipper = document.getElementById('filterShipper').value;
      const status = document.getElementById('filterStatus').value;
      
      let filtered = AppState.requests;
      
      if (startDate) {
        filtered = filtered.filter(req => req.loadDate >= startDate);
      }
      if (endDate) {
        filtered = filtered.filter(req => req.loadDate <= endDate);
      }
      if (shipper) {
        filtered = filtered.filter(req => req.shipper === shipper); // ★ MOD: shipperId ではなく shipper (name)
      }
      if (status === 'assigned') {
        filtered = filtered.filter(req => req.vehicleNumber);
      } else if (status === 'unassigned') {
        filtered = filtered.filter(req => !req.vehicleNumber);
      }
      
      this.renderTable(filtered);
      this.updateRequestCount(filtered.length);
    },
    
    resetFilters() {
      document.getElementById('filterStartDate').value = '';
      document.getElementById('filterEndDate').value = '';
      document.getElementById('filterShipper').value = '';
      document.getElementById('filterStatus').value = '';
      
      const selects = document.querySelectorAll('select');
      M.FormSelect.init(selects);
      
      this.renderTable(AppState.requests);
      this.updateRequestCount(AppState.requests.length);
    },

    updateRequestCount(count) {
      const countElem = document.getElementById('requestCount');
      if (countElem) {
        countElem.textContent = `全 ${count} 件`;
      }
    },
    
    /**
     * ★ NEW: 編集ボタンクリック処理
     */
    handleEditClick(requestId) {
      console.log('Edit clicked:', requestId);
      Navigation.navigateToPage('request-form', { 
        mode: 'edit', 
        requestId: requestId 
      }, { source: 'list-edit-btn' });
    },
    
    /**
     * ★ NEW: 削除ボタンクリック処理
     */
    async handleDeleteClick(requestId) {
      console.log('Delete clicked:', requestId);
      if (!UI.confirm(`依頼ID: ${requestId} を削除しますか？\nこの操作は元に戻せません。`)) {
        return;
      }
      
      try {
        UI.showLoading('依頼を削除中...');
        const result = await API.deleteRequest(requestId);
        UI.hideLoading();
        
        if (result.success) {
          UI.showSuccess('依頼を削除しました');
          await this.loadRequests(); // 一覧を再読み込み
        } else {
          UI.showError('依頼の削除に失敗しました: ' + result.message);
        }
      } catch (error) {
        console.error('Delete request error:', error);
        UI.hideLoading();
        UI.showError('依頼の削除に失敗しました: ' + error.message);
      }
    }
  };
  
  // 配車計画モジュール
  const DispatchPlan = {
    async init() {
      console.log('DispatchPlan init');
      this.setupEventListeners();
      this.populateFilters();
      await this.loadRequests();
    },

    populateFilters() {
      Utils.populateSelect('planFilterShipper', AppState.shippers, 'shipperId', 'shipperName', 'すべての荷主');
      Utils.populateSelect('planFilterType', AppState.requestTypes.map(type => ({
        value: type,
        label: type
      })), 'value', 'label', 'すべての車種');
    },
    
    async loadRequests() {
      try {
        UI.showLoading('依頼データを読み込み中...');
        const requests = await API.getAllRequests();
        AppState.requests = requests;
        this.applyPlanFilters(); // デフォルトフィルター（未配車のみ）を適用
        UI.hideLoading();
      } catch (error) {
        console.error('Load requests error:', error);
        UI.hideLoading();
        UI.showError('依頼データの読み込みに失敗しました');
      }
    },
    
    renderRequests(requests) {
      const container = document.getElementById('unassignedRequests');
      if (!container) return;

      const countElem = document.getElementById('unassignedCount');
      if (countElem) {
        countElem.textContent = `(${requests.length} 件)`;
      }
      
      if (requests.length === 0) {
        container.innerHTML = '<p class="text-center text-secondary">対象の依頼はありません</p>';
        return;
      }
      
      // ★ MOD: 依頼日（loadDate）でソート（古いものが上）
      const sortedRequests = Utils.sortArray(requests, 'loadDate', true);
      
      container.innerHTML = sortedRequests.map(req => `
        <div class="request-card" data-request-id="${req.requestId}">
          <div class="request-card-header">
            <span class="request-id">${req.requestId}</span>
            <span class="chip chip-info">${req.requestType}</span>
          </div>
          <div class="request-info">
            <strong>${req.shipper}</strong> - ${req.productName}
          </div>
          <div class="request-info">
            積込: ${Utils.formatDateJP(req.loadDate)} ${req.loadTime || ''} - ${req.loadPlace1}
          </div>
          <div class="request-info">
            荷卸: ${Utils.formatDateJP(req.unloadDate)} ${req.unloadTime || ''} - ${req.unloadPlace1}
          </div>
        </div>
      `).join('');
    },
    
    setupEventListeners() {
      const applyBtn = document.getElementById('planApplyFilterBtn');
      if (applyBtn) {
        applyBtn.addEventListener('click', () => this.applyPlanFilters());
      }
      
      const resetBtn = document.getElementById('planResetFilterBtn');
      if (resetBtn) {
        resetBtn.addEventListener('click', () => this.resetPlanFilters());
      }
      
      const cancelBtn = document.getElementById('cancelVehicleSelectBtn');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => this.cancelVehicleSelection());
      }
      
      const unassignedContainer = document.getElementById('unassignedRequests');
      if (unassignedContainer) {
        unassignedContainer.addEventListener('click', (e) => {
          const card = e.target.closest('.request-card');
          if (card) {
            const requestId = card.dataset.requestId;
            this.selectRequestForDispatch(requestId);
          }
        });
      }
    },
    
    applyPlanFilters() {
      if (!AppState.requests) return;
      
      const date = document.getElementById('planFilterDate').value;
      const shipper = document.getElementById('planFilterShipper').value;
      const type = document.getElementById('planFilterType').value;
      const unassignedOnly = document.getElementById('planFilterUnassigned').checked;
      
      let filtered = AppState.requests;
      
      if (unassignedOnly) {
        filtered = filtered.filter(req => !req.vehicleNumber);
      }
      if (date) {
        filtered = filtered.filter(req => req.loadDate === date);
      }
      if (shipper) {
        filtered = filtered.filter(req => req.shipper === shipper); // ★ MOD: shipperId ではなく shipper (name)
      }
      if (type) {
        filtered = filtered.filter(req => req.requestType === type);
      }
      
      this.renderRequests(filtered);
    },
    
    resetPlanFilters() {
      document.getElementById('planFilterDate').value = '';
      document.getElementById('planFilterShipper').value = '';
      document.getElementById('planFilterType').value = '';
      document.getElementById('planFilterUnassigned').checked = true;
      
      const selects = document.querySelectorAll('select');
      M.FormSelect.init(selects);
      
      const unassigned = AppState.requests.filter(req => !req.vehicleNumber);
      this.renderRequests(unassigned);
    },
    
    async selectRequestForDispatch(requestId) {
      try {
        const request = AppState.requests.find(r => r.requestId === requestId);
        if (!request) return;
        
        AppState.selectedRequest = request;
        
        const cards = document.querySelectorAll('.request-card');
        cards.forEach(card => {
          card.classList.toggle('selected', card.dataset.requestId === requestId);
        });
        
        this.showVehicleSelector(request);
        
        UI.showLoading('利用可能な車両を検索中...');
        const vehicles = await API.getAvailableVehicles(request);
        UI.hideLoading();
        
        this.renderAvailableVehicles(vehicles, request);
        
      } catch (error) {
        console.error('Select request error:', error);
        UI.hideLoading();
        UI.showError('車両の検索に失敗しました: ' + error.message);
      }
    },
    
    showVehicleSelector(request) {
      Utils.toggleElement('vehicleSelectorCard', true);
      Utils.toggleElement('helpCard', false);
      
      const infoDiv = document.getElementById('selectedRequestInfo');
      if (infoDiv) {
        infoDiv.innerHTML = `
          <div style="background-color: #E3F2FD; padding: 15px; border-radius: 5px;">
            <h6 style="margin: 0 0 10px 0; color: #1976D2;">
              <strong>${request.requestId}</strong>
            </h6>
            <p style="margin: 5px 0;"><strong>荷主:</strong> ${request.shipper}</p>
            <p style="margin: 5px 0;"><strong>品名:</strong> ${request.productName}</p>
            <p style="margin: 5px 0;"><strong>積込:</strong> ${Utils.formatDateJP(request.loadDate)} ${request.loadTime || ''}</p>
            <p style="margin: 5px 0;"><strong>荷卸:</strong> ${Utils.formatDateJP(request.unloadDate)} ${request.unloadTime || ''}</p>
            <p style="margin: 5px 0;"><strong>依頼車種:</strong> <span class="chip chip-info">${request.requestType}</span></p>
          </div>
        `;
      }
    },
    
    renderAvailableVehicles(vehicles, request) {
      const container = document.getElementById('availableVehicles');
      if (!container) return;
      
      if (vehicles.length === 0) {
        container.innerHTML = '<p class="text-center text-secondary">この依頼に割り当て可能な車両がありません</p>';
        return;
      }
      
      container.innerHTML = vehicles.map(vehicle => `
        <div class="vehicle-item" data-vehicle-number="${vehicle.number}">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>${vehicle.number}</strong>
              <span class="chip chip-info" style="margin-left: 10px;">${vehicle.vehicleType}</span>
            </div>
            <button class="btn-small waves-effect waves-light blue darken-1 assign-vehicle-btn" 
                    data-vehicle-number="${vehicle.number}"
                    data-request-id="${request.requestId}">
              <i class="material-icons left">check</i>
              割り当て
            </button>
          </div>
          <div style="margin-top: 5px; font-size: 0.875rem; color: #757575;">
            <div>車番: ${vehicle.radioNumber || '-'}</div>
            <div>運転手: ${vehicle.driverName || '-'}</div>
            <div>積載量: ${vehicle.capacity || '-'}</div>
          </div>
        </div>
      `).join('');
      
      const assignBtns = container.querySelectorAll('.assign-vehicle-btn');
      assignBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const vehicleNumber = btn.dataset.vehicleNumber;
          const requestId = btn.dataset.requestId;
          this.assignVehicleToRequest(requestId, vehicleNumber);
        });
      });
    },
    
    async assignVehicleToRequest(requestId, vehicleNumber) {
      if (!UI.confirm('この車両を割り当てますか?')) {
        return;
      }
      
      try {
        UI.showLoading('車両を割り当て中...');
        const result = await API.assignVehicle(requestId, vehicleNumber);
        UI.hideLoading();
        
        if (result.success) {
          UI.showSuccess('車両を割り当てました');
          await this.loadRequests();
          this.cancelVehicleSelection();
        } else {
          UI.showError('車両の割り当てに失敗しました: ' + result.message);
        }
      } catch (error) {
        console.error('Assign vehicle error:', error);
        UI.hideLoading();
        UI.showError('車両の割り当てに失敗しました: ' + error.message);
      }
    },
    
    cancelVehicleSelection() {
      Utils.toggleElement('vehicleSelectorCard', false);
      Utils.toggleElement('helpCard', true);
      
      const cards = document.querySelectorAll('.request-card');
      cards.forEach(card => card.classList.remove('selected'));
      
      AppState.selectedRequest = null;
    }
  };
  
  // ===========================================================================
  // グローバルに公開
  // ===========================================================================
  
  window.App = App;
  window.AppState = AppState;
  window.API = API;
  window.UI = UI;
  window.Utils = Utils;
  window.RequestForm = RequestForm;
  window.RequestList = RequestList;
  window.DispatchPlan = DispatchPlan;
  
  // ===========================================================================
  // DOMContentLoaded イベント
  // ===========================================================================
  
  document.addEventListener('DOMContentLoaded', () => {
    console.log('DOMContentLoaded: App initializing...');
    console.log('[DEBUG] Current page from APP_CONFIG:', window.APP_CONFIG.currentPage);

    document.querySelectorAll('.loading-overlay').forEach(el => {
      console.warn('[EMERGENCY CLEANUP] Removing orphaned loading overlay');
      el.remove();
    });

    const initialPage = window.APP_CONFIG.currentPage;
    console.log('[SPA] Setting initial active page:', initialPage);
    document.querySelectorAll(`nav a[data-page="${initialPage}"]`).forEach(link => {
      const li = link.closest('li');
      if (li) {
        li.classList.add('active');
      }
    });

    App.init();
  });
  
})();
</script>